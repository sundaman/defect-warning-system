<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defect Warning Dashboard v2.0</title>
    <!-- å¼•å…¥ Vue 3 å’Œ ECharts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .chart-container {
            height: 500px;
            width: 100%;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }

        /* Modal Transition */
        .modal-enter-active,
        .modal-leave-active {
            transition: opacity 0.3s ease;
        }

        .modal-enter-from,
        .modal-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body class="p-6">
    <div id="app">
        <!-- Header & Filters -->
        <!-- Navbar -->
        <nav class="bg-white shadow mb-6 rounded-lg px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <span class="text-xl font-bold text-gray-800">ğŸ­ ç¼ºé™·é¢„è­¦ç³»ç»Ÿ</span>
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button @click="currentTab = 'dashboard'"
                        :class="['px-4 py-1.5 rounded-md text-sm font-medium transition', currentTab === 'dashboard' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700']">
                        ğŸ“Š ç›‘æ§çœ‹æ¿
                    </button>
                    <button @click="currentTab = 'config'"
                        :class="['px-4 py-1.5 rounded-md text-sm font-medium transition', currentTab === 'config' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700']">
                        âš™ï¸ å‚æ•°é…ç½®
                    </button>
                </div>
            </div>
            <div class="text-sm text-gray-500">v2.1.0</div>
        </nav>

        <!-- DASHBOARD VIEW -->
        <div v-show="currentTab === 'dashboard'">
            <!-- ç­›é€‰æ  -->
            <div class="bg-white p-4 rounded-lg shadow mb-6 flex flex-wrap gap-4 items-end">

                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                    <input type="text" list="item-names" v-model="filters.item_name" @input="fetchOptions"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
                        placeholder="Select or type Item...">
                    <datalist id="item-names">
                        <option v-for="item in options.items" :key="item" :value="item"></option>
                    </datalist>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Station <span
                            class="text-red-500">*</span></label>
                    <select v-model="filters.station" @change="fetchOptions"
                        class="w-full border rounded p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Station</option>
                        <option v-for="s in options.stations" :key="s" :value="s">{{ s }}</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product <span
                            class="text-red-500">*</span></label>
                    <select v-model="filters.product" @change="fetchOptions"
                        class="w-full border rounded p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Product</option>
                        <option v-for="p in options.products" :key="p" :value="p">{{ p }}</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Line <span
                            class="text-red-500">*</span></label>
                    <select v-model="filters.line" @change="fetchOptions"
                        class="w-full border rounded p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Line</option>
                        <option v-for="l in options.lines" :key="l" :value="l">{{ l }}</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                    <input v-model="filters.start_time" type="date"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <!-- End Time & Search Btn -->
                <div class="flex-1 min-w-[150px] flex gap-2">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                        <input v-model="filters.end_time" type="date"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <button @click="searchHistory"
                        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 self-end h-[42px] flex items-center">
                        <i class="fas fa-search mr-2"></i> æŸ¥è¯¢
                    </button>
                </div>
            </div>
            </header>

            <!-- Main Chart -->
            <div class="mb-6">
                <div class="flex justify-between items-end mb-2">
                    <h2 class="text-lg font-semibold text-gray-700">ğŸ“ˆ æ£€æµ‹è¶‹åŠ¿æ€»è§ˆ</h2>
                    <span class="text-sm text-gray-400">åŒå‡»å›¾è¡¨å¯ç¼©æ”¾ï¼Œé¼ æ ‡æ»šè½®å¹³ç§»</span>
                </div>
                <div id="mainChart" class="chart-container"></div>
            </div>

            <!-- Secondary Grid -->
            <div class="grid grid-cols-2 gap-6">
                <!-- Baseline Chart -->
                <div>
                    <h2 class="text-lg font-semibold mb-2 text-gray-700">ğŸ“Š ç»Ÿè®¡ç‰¹å¾å˜åŒ–</h2>
                    <div id="baselineChart" class="chart-container" style="height: 400px;"></div>
                </div>
                <!-- Alert History -->
                <div>
                    <h2 class="text-lg font-semibold mb-2 text-gray-700">ğŸš¨ æœ€è¿‘æŠ¥è­¦è®°å½• (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</h2>
                    <div class="chart-container overflow-auto" style="height: 400px; padding: 0;">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3">Item</th>
                                    <th class="px-4 py-3">Time</th>
                                    <th class="px-4 py-3">Val / H</th>
                                    <th class="px-4 py-3 text-right">Score</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="record in alertRecords" :key="record.id" @click="openDetail(record)"
                                    class="cursor-pointer hover:bg-red-50 transition-colors">
                                    <td class="px-4 py-3 font-medium text-gray-900">{{ record.item_name }}</td>
                                    <td class="px-4 py-3">{{ formatTime(record.timestamp) }}</td>
                                    <td class="px-4 py-3">
                                        <div>V: {{ record.value.toFixed(4) }}</div>
                                        <div class="text-xs text-gray-400">H: {{ record.h_value?.toFixed(2) }}</div>
                                    </td>
                                    <td class="px-4 py-3 text-right font-bold text-red-600">{{ record.s_plus.toFixed(1)
                                        }}
                                    </td>
                                </tr>
                                <tr v-if="alertRecords.length === 0">
                                    <td colspan="4" class="text-center py-8 text-gray-400">æš‚æ— æŠ¥è­¦è®°å½•</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Detail Modal -->
            <Transition name="modal">
                <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                    @click.self="showModal = false">
                    <div class="bg-white rounded-lg shadow-xl w-3/4 max-w-5xl p-6 h-3/4 flex flex-col">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">ğŸ” æŠ¥è­¦è¯¦æƒ…åˆ†æ</h3>
                                <p class="text-sm text-gray-500">Item: {{ selectedRecord?.item_name }} | Time: {{
                                    formatTime(selectedRecord?.timestamp) }}</p>
                            </div>
                            <button @click="showModal = false"
                                class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>

                        <div id="detailChart" class="flex-grow w-full bg-gray-50 rounded"></div>

                        <div class="grid grid-cols-4 gap-4 mt-4 text-sm text-gray-600 bg-gray-100 p-3 rounded">
                            <div>Station: <span class="font-medium text-gray-800">{{ selectedRecord?.station || '-'
                                    }}</span></div>
                            <div>Product: <span class="font-medium text-gray-800">{{ selectedRecord?.product || '-'
                                    }}</span></div>
                            <div>Line: <span class="font-medium text-gray-800">{{ selectedRecord?.line || '-' }}</span>
                            </div>
                            <div>CUSUM Score: <span class="font-bold text-red-600">{{ selectedRecord?.s_plus.toFixed(2)
                                    }}</span></div>
                        </div>
                    </div>
                </div>
            </Transition>
        </div><!-- End of Dashboard View -->

        <!-- CONFIGURATION VIEW -->
        <div v-show="currentTab === 'config'" class="space-y-6">

            <!-- Global Config Card -->
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-6 shadow-sm">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">ğŸŒ é»˜è®¤ç­–ç•¥é…ç½® (Default Policy)</h2>
                        <p class="text-sm text-gray-500 mt-1">æ­¤å¤„çš„è®¾ç½®å°†ä½œä¸ºé»˜è®¤å€¼åº”ç”¨åˆ°<b>æ–°å¯¼å…¥</b>çš„ç›‘æ§é¡¹ã€‚<b>ä¸ä¼š</b>å½±å“å·²è¿è¡Œçš„é¡¹ç›®ã€‚</p>
                    </div>
                    <button @click="saveGlobalConfig"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm transition">
                        <i class="fas fa-save mr-1"></i> Save Global Policy
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Target Shift -->
                    <div class="bg-white p-3 rounded border border-gray-100 hover:shadow-sm transition">
                        <label class="block text-sm font-bold text-gray-700 mb-1">
                            <i class="fas fa-search-plus mr-1 text-blue-500"></i> ç›®æ ‡åç§» (Target Ïƒ)
                        </label>
                        <input type="number" step="0.1" v-model.number="globalDefaults.target_shift_sigma"
                            class="w-full border-gray-300 rounded shadow-sm p-2 mb-2 focus:ring-blue-500 focus:border-blue-500">
                        <div class="text-xs text-gray-500 space-y-1">
                            <p><strong>æ£€æµ‹çµæ•åº¦ (Sensitivity)</strong></p>
                            <p>è®¾å®šéœ€è¦æ£€æµ‹çš„åç§»é‡ï¼ˆæ ‡å‡†å·®å€æ•°ï¼‰ã€‚</p>
                            <ul class="list-disc pl-3 text-gray-400">
                                <li>0.5~1.0: é«˜çµæ•ï¼Œæ˜“è¯¯æŠ¥ã€‚</li>
                                <li>1.5~2.0: æ¨èï¼Œå¹³è¡¡ç‚¹ã€‚</li>
                                <li>>2.5: å®½æ¾ï¼Œä»…æŠ“å¤§å¼‚å¸¸ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Target ARL0 -->
                    <div class="bg-white p-3 rounded border border-gray-100 hover:shadow-sm transition">
                        <label class="block text-sm font-bold text-gray-700 mb-1">
                            <i class="fas fa-shield-alt mr-1 text-green-500"></i> è¯¯æŠ¥æ§åˆ¶ (Target ARLâ‚€)
                        </label>
                        <input type="number" step="10" v-model.number="globalDefaults.target_arl0"
                            class="w-full border-gray-300 rounded shadow-sm p-2 mb-2 focus:ring-blue-500 focus:border-blue-500">
                        <div class="text-xs text-gray-500 space-y-1">
                            <p><strong>è¯¯æŠ¥æ§åˆ¶ (False Alarm Rate)</strong></p>
                            <p>è®¾å®šæ— ç¼ºé™·æ—¶çš„é¢„æœŸå¹³å‡è¿è¡Œé•¿åº¦ã€‚</p>
                            <ul class="list-disc pl-3 text-gray-400">
                                <li>100~300: ååº”å¿«ï¼Œè¯¯æŠ¥ç•¥å¤šã€‚</li>
                                <li>500~1000: æå°‘è¯¯æŠ¥ï¼Œå»¶è¿Ÿç¨é«˜ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Estimated h (Calculated) -->
                    <div class="bg-blue-50 p-3 rounded border border-blue-100 hover:shadow-sm transition">
                        <label class="block text-sm font-bold text-blue-800 mb-1">
                            <i class="fas fa-calculator mr-1"></i> é¢„ä¼°é˜ˆå€¼ (Estimated h)
                        </label>
                        <div class="text-3xl font-mono font-bold text-blue-700 my-2">
                            {{ calculateH(globalDefaults.target_shift_sigma, globalDefaults.target_arl0) }}
                        </div>
                        <div class="text-xs text-blue-600 space-y-1">
                            <p><strong>å®é™…æŠ¥è­¦é˜ˆå€¼</strong></p>
                            <p class="opacity-80">æ ¹æ® Shift å’Œ ARL0 è‡ªåŠ¨è®¡ç®—ã€‚</p>
                            <p class="font-mono text-[10px] mt-1">h â‰ˆ 2/ÏƒÂ² * ln(ARLâ‚€)</p>
                        </div>
                    </div>

                    <!-- Cooldown -->
                    <div class="bg-white p-3 rounded border border-gray-100 hover:shadow-sm transition">
                        <label class="block text-sm font-bold text-gray-700 mb-1">
                            <i class="fas fa-snowflake mr-1 text-cyan-500"></i> å†·å´å‘¨æœŸ (Cooldown)
                        </label>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="number" step="1" v-model.number="globalDefaults.cooldown_periods"
                                class="w-full border-gray-300 rounded shadow-sm p-2" placeholder="Value">
                            <div class="flex items-center">
                                <input type="checkbox" v-model="globalDefaults.enable_cooldown"
                                    class="h-4 w-4 text-blue-600 rounded cursor-pointer" title="Enable/Disable">
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 space-y-1">
                            <p><strong>æŠ¥è­¦å†·å´ (Suppression)</strong></p>
                            <p>æŠ¥è­¦è§¦å‘åæš‚åœç›‘æµ‹çš„å‘¨æœŸæ•°ï¼Œé˜²åˆ·å±ã€‚</p>
                            <ul class="list-disc pl-3 text-gray-400">
                                <li>å»ºè®®å€¼: 10~50 (å–å†³äºé‡‡æ ·ç‡)ã€‚</li>
                                <li>Ticks: On=å¯ç”¨, Off=ç¦ç”¨ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Monitoring Side -->
                    <div class="bg-white p-3 rounded border border-gray-100 hover:shadow-sm transition">
                        <label class="block text-sm font-bold text-gray-700 mb-1">
                            <i class="fas fa-arrows-alt-v mr-1 text-purple-500"></i> ç›‘æ§æ–¹å‘ (Monitoring Side)
                        </label>
                        <select v-model="globalDefaults.monitoring_side"
                            class="w-full border-gray-300 rounded shadow-sm p-2 mb-2 text-sm bg-white">
                            <option value="upper">ä¸Šé™ (Upper) - é£™å‡</option>
                            <option value="lower">ä¸‹é™ (Lower) - éª¤é™</option>
                            <option value="both">åŒä¾§ (Both) - æ³¢åŠ¨</option>
                            <option value="">è‡ªåŠ¨ (None/Auto)</option>
                        </select>
                        <div class="text-xs text-gray-500 space-y-1">
                            <p><strong>ç›‘æ§æ–¹å‘ (Direction)</strong></p>
                            <p>è®¾å®šå…³æ³¨çš„å¼‚å¸¸æ–¹å‘ã€‚</p>
                            <ul class="list-disc pl-3 text-gray-400">
                                <li>Upper: å…³æ³¨æ•°å€¼å˜å¤§ (å¦‚ç¼ºé™·ç‡)ã€‚</li>
                                <li>Lower: å…³æ³¨æ•°å€¼å˜å° (å¦‚è‰¯ç‡)ã€‚</li>
                                <li>Both: å…³æ³¨åŒå‘æ³¢åŠ¨ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Base UPH -->
                    <div class="bg-white p-3 rounded border border-gray-100 hover:shadow-sm transition">
                        <label class="block text-sm font-bold text-gray-700 mb-1">
                            <i class="fas fa-industry mr-1 text-orange-500"></i> åŸºå‡†äº§èƒ½ (Base UPH)
                        </label>
                        <input type="number" step="1" v-model.number="globalDefaults.base_uph" placeholder="500"
                            class="w-full border-gray-300 rounded shadow-sm p-2 mb-2 focus:ring-blue-500 focus:border-blue-500">
                        <div class="text-xs text-gray-500 space-y-1">
                            <p><strong>åŸºå‡†äº§èƒ½ (Standard Capacity)</strong></p>
                            <p>ç”¨äºä½äº§èƒ½ä¸èƒ½æ—¶çš„æ³¢åŠ¨æ ‡å‡†åŒ–ã€‚</p>
                            <ul class="list-disc pl-3 text-gray-400">
                                <li>é»˜è®¤: 500 pcs/hrã€‚</li>
                                <li>è‹¥å®é™…UPHè¿œä½äºæ­¤ï¼Œä¼šè‡ªåŠ¨æ”¾å®½é˜ˆå€¼ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Penalty Strength -->
                    <div class="bg-white p-3 rounded border border-gray-100 hover:shadow-sm transition">
                        <label class="block text-sm font-bold text-gray-700 mb-1">
                            <i class="fas fa-balance-scale mr-1 text-pink-500"></i> ä½äº§å®½å®¹åº¦ (Penalty Strength)
                        </label>
                        <select v-model.number="globalDefaults.penalty_strength"
                            class="w-full border-gray-300 rounded shadow-sm p-2 mb-2 text-sm bg-white">
                            <option :value="1.0">ä¸¥æ ¼ (Strict 1.0)</option>
                            <option :value="0.6">é€‚ä¸­ (Moderate 0.6)</option>
                            <option :value="0.3">å®½æ¾ (Relaxed 0.3)</option>
                        </select>
                        <div class="text-xs text-gray-500 space-y-1">
                            <p><strong>ä½äº§å®½å®¹åº¦ (Tolerance)</strong></p>
                            <p>äº§èƒ½ä¸è¶³æ—¶ï¼Œå¯¹æ³¢åŠ¨çš„å®¹å¿ç¨‹åº¦ã€‚</p>
                            <ul class="list-disc pl-3 text-gray-400">
                                <li>1.0: ä¸¥æ ¼ï¼ŒæŒ‰ç»Ÿè®¡å­¦è§„å¾‹æ”¾å®½ã€‚</li>
                                <li>0.3: å®½æ¾ï¼Œå‡è®¾å³ä¾¿æ˜¯ä½äº§ä¹Ÿå¾ˆç¨³å®šã€‚</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <!-- Header Actions Row -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <span>ğŸ“‹ ç›‘æ§é¡¹åˆ—è¡¨</span>
                        <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full">Total: {{
                            Object.keys(filteredConfigs).length }}</span>
                    </h2>
                    <div class="flex gap-2">
                        <button v-if="selectedItems.length > 0" @click="batchDelete"
                            class="text-red-600 hover:text-red-800 text-sm flex items-center bg-red-50 px-3 py-1.5 rounded border border-red-200 transition">
                            <i class="fas fa-trash-alt mr-1"></i> æ‰¹é‡åˆ é™¤ ({{ selectedItems.length }})
                        </button>
                        <button @click="openImportModal"
                            class="text-green-600 hover:text-green-800 text-sm flex items-center bg-green-50 px-3 py-1.5 rounded border border-green-200 transition">
                            <i class="fas fa-plus-circle mr-1"></i> åˆ›å»ºæ£€æµ‹å™¨
                        </button>
                        <button @click="fetchConfigs"
                            class="text-blue-600 hover:text-blue-800 text-sm flex items-center bg-blue-50 px-3 py-1.5 rounded border border-blue-200 transition">
                            <i class="fas fa-sync mr-1"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>

                <!-- Filters Row -->
                <div class="bg-gray-50 p-3 rounded mb-4 border border-gray-100">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 text-xs font-bold uppercase">Search:</span>
                            <div class="relative">
                                <i class="fas fa-search absolute left-2 top-2.5 text-gray-400 text-xs"></i>
                                <input v-model="configFilters.itemName" type="text" placeholder="Item Name..."
                                    class="border border-gray-300 rounded pl-7 pr-2 py-1.5 text-sm w-56 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition bg-white">
                            </div>
                        </div>

                        <div class="h-6 w-px bg-gray-300"></div>

                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 text-xs font-bold uppercase">Context:</span>
                            <input v-model="configFilters.product" type="text" placeholder="Product"
                                class="border border-gray-300 rounded px-2 py-1.5 text-sm w-32 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition bg-white">
                            <input v-model="configFilters.station" type="text" placeholder="Station"
                                class="border border-gray-300 rounded px-2 py-1.5 text-sm w-28 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition bg-white">
                            <input v-model="configFilters.line" type="text" placeholder="Line"
                                class="border border-gray-300 rounded px-2 py-1.5 text-sm w-24 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition bg-white">
                        </div>

                        <button
                            v-if="configFilters.itemName || configFilters.product || configFilters.station || configFilters.line"
                            @click="Object.assign(configFilters, {itemName: '', product: '', station: '', line: ''})"
                            class="ml-auto text-xs text-blue-600 hover:text-blue-800 hover:underline">
                            Clear Filters
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 table-fixed">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 w-10">
                                    <input type="checkbox" :checked="isAllSelected" @click="toggleSelectAll"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </th>
                                <th class="px-4 py-3 w-[550px]">Item Name</th>
                                <th class="px-4 py-3 w-28">Product</th>
                                <th class="px-4 py-3 w-24">Station</th>
                                <th class="px-4 py-3 w-20">Line</th>
                                <th class="px-4 py-3 w-20" title="Target Shift (Ïƒ)">Shift(Ïƒ)</th>
                                <th class="px-4 py-3 w-20">ARLâ‚€</th>
                                <th class="px-4 py-3 w-20">Cool</th>
                                <th class="px-4 py-3 w-20">Î¼â‚€</th>
                                <th class="px-4 py-3 w-20">UPH</th>
                                <th class="px-4 py-3 w-20">Pen</th>
                                <th class="px-4 py-3 w-20">Side</th>
                                <th class="px-4 py-3 w-36 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr v-for="(item, key) in filteredConfigs" :key="key" class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <input type="checkbox" :value="key" v-model="selectedItems"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </td>

                                <td class="px-4 py-3 font-medium text-gray-900 truncate" :title="item.meta.item_name">
                                    {{ item.meta.item_name }}
                                </td>

                                <!-- Context Columns -->
                                <td class="px-4 py-3">
                                    <span v-if="item.meta.product"
                                        class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded">{{
                                        item.meta.product }}</span>
                                    <span v-else class="text-gray-400 text-xs">ALL (Generic)</span>
                                </td>
                                <td class="px-4 py-3">
                                    <span v-if="item.meta.station" class="text-gray-900">{{ item.meta.station }}</span>
                                    <span v-else class="text-gray-400 text-xs">-</span>
                                </td>
                                <td class="px-4 py-3">
                                    <span v-if="item.meta.line" class="text-gray-900">{{ item.meta.line }}</span>
                                    <span v-else class="text-gray-400 text-xs">-</span>
                                </td>

                                <td class="px-4 py-3">{{ item.conf.target_shift_sigma ??
                                    globalDefaults.target_shift_sigma }}
                                </td>
                                <td class="px-4 py-3">{{ item.conf.target_arl0 ?? globalDefaults.target_arl0 }}</td>
                                <td class="px-4 py-3">{{ item.conf.cooldown_periods ?? globalDefaults.cooldown_periods
                                    }}
                                </td>
                                <td class="px-4 py-3 font-mono text-xs">
                                    <span v-if="item.conf.mu0 !== undefined">{{ item.conf.mu0.toFixed(5) }}</span>
                                    <span v-else class="text-gray-400">0.00050 (Def)</span>
                                </td>
                                <td class="px-4 py-3 font-mono text-xs">
                                    {{ item.conf.base_uph ?? 500 }}
                                </td>
                                <td class="px-4 py-3">
                                    <span v-if="item.conf.penalty_strength === 1.0"
                                        class="text-xs bg-gray-100 px-1 rounded">Strict</span>
                                    <span v-else-if="item.conf.penalty_strength === 0.6"
                                        class="text-xs bg-yellow-100 px-1 rounded">Mod</span>
                                    <span v-else-if="item.conf.penalty_strength === 0.3"
                                        class="text-xs bg-green-100 px-1 rounded">Relax</span>
                                    <span v-else class="text-gray-400 text-xs">1.0</span>
                                </td>
                                <td class="px-4 py-3">
                                    <span
                                        v-if="(item.conf.monitoring_side || globalDefaults.monitoring_side) === 'upper'"
                                        class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-800">Upper</span>
                                    <span
                                        v-else-if="(item.conf.monitoring_side || globalDefaults.monitoring_side) === 'lower'"
                                        class="px-2 py-0.5 rounded text-xs bg-green-100 text-green-800">Lower</span>
                                    <span
                                        v-else-if="(item.conf.monitoring_side || globalDefaults.monitoring_side) === 'both'"
                                        class="px-2 py-0.5 rounded text-xs bg-purple-100 text-purple-800">Both</span>
                                    <span v-else class="text-gray-400">-</span>
                                </td>
                                <td class="px-4 py-3 text-right flex justify-end gap-3">
                                    <button @click="openConfigEdit(key, item.conf)"
                                        class="text-blue-600 hover:text-blue-800 font-medium">Edit</button>
                                    <button @click="deleteItem(key)" class="text-red-500 hover:text-red-700"
                                        title="Delete Item">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="Object.keys(filteredConfigs).length === 0">
                                <td colspan="13" class="text-center py-8 text-gray-400">æš‚æ— é…ç½®é¡¹ï¼ˆè¯·å…ˆè¿›è¡Œæ•°æ®æ³¨å…¥ï¼‰</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Import Items Modal -->
        <Transition name="modal">
            <div v-if="showImportModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-lg font-bold text-gray-800">ğŸ“¥ æ‰¹é‡å¯¼å…¥ç›‘æ§é¡¹ (Batch Import)</h3>
                        <button @click="showImportModal = false"
                            class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>

                    <div class="mb-4">
                        <!-- Context Settings (New) -->
                        <div class="mb-4 bg-blue-50 border border-blue-200 rounded p-3">
                            <h4 class="font-semibold text-gray-800 text-sm mb-2"><i
                                    class="fas fa-tag mr-1 text-blue-600"></i> æ£€æµ‹ç”Ÿæ•ˆèŒƒå›´ (å¿…å¡«)</h4>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div>
                                    <label class="block text-gray-600 mb-1">äº§å“ (Product) <span
                                            class="text-red-500">*</span></label>
                                    <input type="text" v-model="batchContext.product" placeholder="ä¾‹å¦‚: Phone15"
                                        class="w-full border rounded p-1 border-blue-300 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-600 mb-1">å·¥ç«™ (Station) <span
                                            class="text-red-500">*</span></label>
                                    <input type="text" v-model="batchContext.station" placeholder="ä¾‹å¦‚: S01"
                                        class="w-full border rounded p-1 border-blue-300 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-600 mb-1">äº§çº¿ (Line) <span
                                            class="text-red-500">*</span></label>
                                    <input type="text" v-model="batchContext.line" placeholder="ä¾‹å¦‚: L-A"
                                        class="w-full border rounded p-1 border-blue-300 focus:ring-blue-500">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">è¯·åŠ¡å¿…ä¸MESæ•°æ®èŒƒå›´ä¿æŒä¸€è‡´ã€‚</p>
                        </div>

                        <!-- Batch Settings Toggle -->
                        <div class="mb-4 border rounded p-3 bg-gray-50">
                            <div class="flex justify-between items-center cursor-pointer"
                                @click="showBatchSettings = !showBatchSettings">
                                <h4 class="font-semibold text-gray-700 text-sm"><i class="fas fa-sliders-h mr-1"></i>
                                    æ‰¹é‡å‚æ•°é…ç½® (Batch Settings)</h4>
                                <i :class="showBatchSettings ? 'fa-chevron-up' : 'fa-chevron-down'"
                                    class="fas text-gray-400"></i>
                            </div>

                            <div v-show="showBatchSettings" class="mt-3 grid grid-cols-2 gap-3 text-sm transition-all">
                                <div>
                                    <label class="block text-gray-600 mb-1">ç›®æ ‡åç§» (Target Ïƒ)</label>
                                    <input type="number" step="0.1" v-model.number="batchConfig.target_shift_sigma"
                                        class="w-full border rounded p-1">
                                </div>
                                <div>
                                    <label class="block text-gray-600 mb-1">è¯¯æŠ¥æ§åˆ¶ (ARLâ‚€)</label>
                                    <input type="number" step="10" v-model.number="batchConfig.target_arl0"
                                        class="w-full border rounded p-1">
                                </div>
                                <div>
                                    <label class="block text-gray-600 mb-1">å†·å´å‘¨æœŸ (Cooldown)</label>
                                    <input type="number" step="1" v-model.number="batchConfig.cooldown_periods"
                                        class="w-full border rounded p-1">
                                </div>
                                <div>
                                    <label class="block text-gray-600 mb-1">ç›‘æ§æ–¹å‘ (Side)</label>
                                    <select v-model="batchConfig.monitoring_side"
                                        class="w-full border rounded p-1 bg-white">
                                        <option value="upper">ä¸Šé™ (Upper)</option>
                                        <option value="lower">ä¸‹é™ (Lower)</option>
                                        <option value="both">åŒä¾§ (Both)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-600 mb-1">åŸºå‡†äº§èƒ½ (Base UPH)</label>
                                    <input type="number" step="1" v-model.number="batchConfig.base_uph"
                                        placeholder="500" class="w-full border rounded p-1">
                                </div>
                                <div>
                                    <label class="block text-gray-600 mb-1">å®¹å¿åº¦ (Penalty)</label>
                                    <select v-model.number="batchConfig.penalty_strength"
                                        class="w-full border rounded p-1 bg-white">
                                        <option :value="1.0">ä¸¥æ ¼ (Strict 1.0)</option>
                                        <option :value="0.6">é€‚ä¸­ (Mod 0.6)</option>
                                        <option :value="0.3">å®½æ¾ (Relax 0.3)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="flex border-b border-gray-200 mb-4">
                            <button class="px-4 py-2 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                                <i class="fas fa-paste mr-2"></i>æ–‡æœ¬ç²˜è´´ (Text Paste)
                            </button>
                            <button @click="triggerFileUpload"
                                class="px-4 py-2 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="fas fa-file-excel mr-2"></i>æ–‡ä»¶ä¸Šä¼  (File Upload)
                            </button>
                            <input type="file" ref="fileInput" class="hidden" accept=".csv,.txt,.xlsx,.xls"
                                @change="handleFileUpload">
                        </div>

                        <p class="text-sm text-gray-600 mb-2">
                            è¯·ç²˜è´´ Item Name åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ã€‚æ”¯æŒç›´æ¥ä» Excel/CSV å¤åˆ¶æ•´åˆ—ã€‚<br>
                            <span class="text-xs text-gray-400">ä¹Ÿæ”¯æŒä¸Šä¼  .xlsx/.csv/.txt æ–‡ä»¶ (è‡ªåŠ¨æå–ç¬¬ä¸€åˆ—)ã€‚</span>
                        </p>
                        <textarea v-model="importText"
                            class="w-full h-48 border rounded p-3 text-sm font-mono bg-gray-50 focus:bg-white"
                            placeholder="S01_CABLE_TEAR_3_1&#10;S01_CABLE_TEAR_3_2&#10;..."></textarea>
                    </div>

                    <div class="flex justify-end gap-3 border-t pt-4">
                        <button @click="showImportModal = false"
                            class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">Cancel</button>
                        <button @click="batchImport"
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            <i class="fas fa-check mr-1"></i> Start Import
                        </button>
                    </div>
                </div>
            </div>
        </Transition>

        <!-- Edit Config Modal -->
        <Transition name="modal">
            <div v-if="showConfigModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-lg font-bold text-gray-800">ç¼–è¾‘é…ç½®: {{ editingItemName }}</h3>
                        <button @click="showConfigModal = false"
                            class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Shift Sigma (æ•é”åº¦)</label>
                            <input type="number" step="0.1" v-model.number="editingConfig.target_shift_sigma"
                                class="w-full border rounded p-2">
                            <p class="text-xs text-gray-500 mt-1">æ£€æµ‹å¤šå°‘ä¸ªæ ‡å‡†å·®çš„åç§»ã€‚è¶Šå°è¶Šçµæ•ã€‚</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target ARL0 (è¯¯æŠ¥æ§åˆ¶)</label>
                            <input type="number" step="10" v-model.number="editingConfig.target_arl0"
                                class="w-full border rounded p-2">
                            <p class="text-xs text-gray-500 mt-1">å¹³å‡è¿è¡Œé•¿åº¦(æ— ç¼ºé™·æ—¶å¤šä¹…è¯¯æŠ¥ä¸€æ¬¡)ã€‚è¶Šå¤§è¯¯æŠ¥è¶Šå°‘ã€‚</p>
                        </div>

                        <!-- Calculated H Preview -->
                        <div class="bg-blue-50 border border-blue-100 rounded p-2 flex justify-between items-center">
                            <span class="text-xs font-bold text-blue-800">Predicted Threshold (h):</span>
                            <span class="text-lg font-mono font-bold text-blue-700">
                                {{ calculateH(editingConfig.target_shift_sigma, editingConfig.target_arl0) }}
                            </span>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cooldown Periods (æŠ¥è­¦å†·å´)</label>
                            <input type="number" step="1" v-model.number="editingConfig.cooldown_periods"
                                class="w-full border rounded p-2">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Base Î¼0 (åˆå§‹åŸºå‡†)</label>
                                <input type="number" step="0.00001" v-model.number="editingConfig.mu0"
                                    class="w-full border rounded p-2 text-sm font-mono" placeholder="Default">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Side (ç›‘æ§æ–¹å‘)</label>
                                <select v-model="editingConfig.monitoring_side"
                                    class="w-full border rounded p-2 bg-white">
                                    <option value="upper">Upper (ä¸Šé™-é£™å‡)</option>
                                    <option value="lower">Lower (ä¸‹é™-éª¤é™)</option>
                                    <option value="both">Both (åŒä¾§-æ³¢åŠ¨)</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Base UPH (åŸºå‡†äº§èƒ½)</label>
                                <input type="number" step="1" v-model.number="editingConfig.base_uph"
                                    class="w-full border rounded p-2 text-sm font-mono" placeholder="500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Penalty (å®½å®¹åº¦)</label>
                                <select v-model.number="editingConfig.penalty_strength"
                                    class="w-full border rounded p-2 bg-white">
                                    <option :value="1.0">Strict (1.0)</option>
                                    <option :value="0.6">Moderate (0.6)</option>
                                    <option :value="0.3">Relaxed (0.3)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end gap-3">
                        <button @click="showConfigModal = false"
                            class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">Cancel</button>
                        <button @click="saveConfig"
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save
                            Changes</button>
                    </div>
                </div>
            </div>
        </Transition>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, nextTick, computed } = Vue;

        createApp({
            setup() {
                const currentTab = ref('dashboard');

                // Dashboard State
                const filters = reactive({
                    item_name: '',
                    station: '',
                    product: '',
                    line: '',
                    start_time: '',
                    end_time: ''
                });

                // Initialize with 24h default
                onMounted(() => {
                    const end = new Date();
                    const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
                    // Format to YYYY-MM-DD (input type="date")
                    filters.end_time = end.toISOString().split('T')[0];
                    filters.start_time = start.toISOString().split('T')[0];
                    fetchOptions();
                    fetchConfigs();
                    // Do not auto-search on load anymore, as context is required
                });

                const options = ref({ items: [], stations: [], products: [], lines: [] });
                const alertRecords = ref([]);
                const showModal = ref(false);
                const selectedRecord = ref(null);
                let mainChart = null, baselineChart = null, detailChart = null;

                // --- Chart Render Logic (Hoisted) ---
                const renderCharts = (data) => {
                    const timestamps = data.map(r => formatTime(r.timestamp));
                    const commonOption = () => ({
                        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                        grid: { left: '3%', right: '3%', bottom: '10%', containLabel: true },
                        dataZoom: [{ type: 'inside' }, { type: 'slider', bottom: 10 }],
                        xAxis: { type: 'category', data: timestamps, boundaryGap: false }
                    });

                    // Main Chart
                    if (mainChart) mainChart.dispose();
                    mainChart = echarts.init(document.getElementById('mainChart'));
                    mainChart.setOption({
                        ...commonOption(),
                        legend: { data: ['Value', 'Threshold (h)', 'CUSUM'] },
                        yAxis: [
                            { type: 'value', name: 'Value', position: 'left' },
                            { type: 'value', name: 'Score', position: 'right', splitLine: { show: false } }
                        ],
                        series: [
                            { name: 'Value', type: 'line', data: data.map(r => r.value), yAxisIndex: 0, smooth: true, itemStyle: { color: '#3b82f6' }, areaStyle: { opacity: 0.1 } },
                            { name: 'Threshold (h)', type: 'line', data: data.map(r => r.h_value), yAxisIndex: 1, lineStyle: { type: 'dashed', color: '#ef4444' }, showSymbol: false },
                            { name: 'CUSUM', type: 'line', data: data.map(r => r.s_plus), yAxisIndex: 1, lineStyle: { color: '#f59e0b', width: 2 } }
                        ]
                    });

                    // Baseline Chart
                    if (baselineChart) baselineChart.dispose();
                    baselineChart = echarts.init(document.getElementById('baselineChart'));
                    baselineChart.setOption({
                        ...commonOption(),
                        legend: { data: ['Baseline (Î¼)', 'Std (Ïƒ)'] },
                        yAxis: [{ type: 'value', name: 'Î¼' }, { type: 'value', name: 'Ïƒ', position: 'right' }],
                        series: [
                            { name: 'Baseline (Î¼)', type: 'line', data: data.map(r => r.baseline), yAxisIndex: 0, color: '#10b981' },
                            { name: 'Std (Ïƒ)', type: 'line', data: data.map(r => r.std), yAxisIndex: 1, color: '#8b5cf6', showSymbol: false }
                        ]
                    });
                    echarts.connect([mainChart, baselineChart]);
                };

                const fetchData = async () => {
                    // æ„å»º Query String
                    const params = new URLSearchParams();
                    if (filters.item_name) params.append('item_name', filters.item_name);
                    if (filters.station) params.append('station', filters.station);
                    if (filters.product) params.append('product', filters.product);
                    if (filters.line) params.append('line', filters.line);
                    if (filters.start_time) params.append('start_time', filters.start_time + 'T00:00:00');
                    if (filters.end_time) params.append('end_time', filters.end_time + 'T23:59:59');
                    params.append('limit', '20000'); // Ensure we get enough points

                    try {
                        const res = await fetch(`/api/v1/history?${params.toString()}`);
                        const data = await res.json();

                        if (data.length === 0) {
                            if (mainChart) mainChart.clear();
                            if (baselineChart) baselineChart.clear();
                            alertRecords.value = [];
                            // Optional: Alert user
                            console.log("No data found for criteria");
                            return;
                        }

                        renderCharts(data);
                        alertRecords.value = data.filter(r => r.is_alert).reverse().slice(0, 100);
                    } catch (e) {
                        console.error("Fetch failed", e);
                    }
                };

                const searchHistory = async () => {
                    if (!filters.item_name) return;
                    // Strict Context Validation
                    if (!filters.station || !filters.product || !filters.line) {
                        alert("è¯·å…ˆé€‰æ‹©å®Œæ•´çš„ Context (Station, Product, Line) ä»¥ç¡®ä¿æ•°æ®å”¯ä¸€æ€§ã€‚");
                        return;
                    }
                    await fetchData();
                };

                // Config State
                const configList = reactive({ item_configs: {} });
                const globalDefaults = ref({});
                const showConfigModal = ref(false);
                const showImportModal = ref(false); // NEW
                const editingItemName = ref('');
                const editingConfig = reactive({});
                const importText = ref(''); // NEW: Text area input
                const importMode = ref('text'); // 'text' or 'csv'
                const configSearch = ref('');
                const showBatchSettings = ref(false);
                const batchConfig = reactive({
                    target_shift_sigma: 1.0,
                    target_arl0: 250,
                    cooldown_periods: 10,
                    monitoring_side: 'upper'
                });

                // Batch Selection
                const selectedItems = ref([]);

                const configFilters = reactive({
                    itemName: '',
                    product: '',
                    station: '',
                    line: ''
                });

                const filteredConfigs = computed(() => {
                    const all = configList.item_configs;
                    const result = {};

                    // Filter terms
                    const fName = (configFilters.itemName || '').toLowerCase();
                    const fProduct = (configFilters.product || '').toLowerCase();
                    const fStation = (configFilters.station || '').toLowerCase();
                    const fLine = (configFilters.line || '').toLowerCase();

                    for (const key in all) {
                        const conf = all[key];
                        // Parse Key or Use Stored Metadata
                        let product = '', line = '', station = '', itemName = key;

                        // Priority 1: Use stored metadata if available (from manual import)
                        if (conf.meta_data) {
                            product = conf.meta_data.product || '';
                            line = conf.meta_data.line || '';
                            station = conf.meta_data.station || '';
                            // If key is composite, extract true item name, otherwise use key
                            if (key.includes('::')) {
                                const parts = key.split('::');
                                itemName = parts[parts.length - 1];
                            }
                        }
                        // Priority 2: Parse from Key (legacy/auto-generated)
                        else if (key.includes('::')) {
                            const parts = key.split('::');
                            if (parts.length === 4) {
                                [product, line, station, itemName] = parts;
                            }
                        }

                        // precise matching logic
                        if (fName && !itemName.toLowerCase().includes(fName)) continue;
                        if (fProduct && !product.toLowerCase().includes(fProduct)) continue;
                        if (fStation && !station.toLowerCase().includes(fStation)) continue;
                        if (fLine && !line.toLowerCase().includes(fLine)) continue;

                        result[key] = {
                            conf: conf,
                            meta: {
                                product: product.toUpperCase(),
                                line: line.toUpperCase(),
                                station: station.toUpperCase(),
                                item_name: itemName
                            }
                        };
                    }
                    return result;
                });

                const isAllSelected = computed(() => {
                    const allKeys = Object.keys(filteredConfigs.value);
                    return allKeys.length > 0 && selectedItems.value.length === allKeys.length;
                });

                const toggleSelectAll = () => {
                    if (isAllSelected.value) {
                        selectedItems.value = [];
                    } else {
                        selectedItems.value = Object.keys(filteredConfigs.value);
                    }
                };

                const batchDelete = async () => {
                    if (selectedItems.value.length === 0) return;
                    if (!confirm(`Are you sure you want to delete ${selectedItems.value.length} items? This cannot be undone.`)) return;

                    try {
                        const res = await fetch('/api/v1/configs/batch-delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ items: selectedItems.value })
                        });

                        const data = await res.json();
                        if (res.ok) {
                            alert(data.message);
                            selectedItems.value = [];
                            fetchConfigs();
                        } else {
                            alert('Batch delete failed: ' + (data.detail || 'Unknown error'));
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Network error');
                    }
                };

                // Format Time
                const formatTime = (isoStr) => {
                    if (!isoStr) return '-';
                    const d = new Date(isoStr);
                    return d.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                };

                // Helper: Calculate H
                const calculateH = (shift, arl0) => {
                    if (!shift || !arl0 || shift <= 0 || arl0 <= 1) return '-';
                    // Formula: h = (2 / shift^2) * ln(arl0)
                    const h = (2.0 / (shift * shift)) * Math.log(arl0);
                    return h.toFixed(4);
                };

                // --- Config Methods ---
                const fetchConfigs = async () => {
                    try {
                        const res = await fetch('/api/v1/configs');
                        const data = await res.json();
                        configList.item_configs = data.item_configs;
                        globalDefaults.value = data.global_defaults;
                    } catch (e) {
                        console.error("Failed to load configs", e);
                    }
                };

                const saveGlobalConfig = async () => {
                    try {
                        const res = await fetch('/api/v1/configs/global', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(globalDefaults.value)
                        });
                        if (res.ok) {
                            alert('å…¨å±€ç­–ç•¥å·²æ›´æ–°å¹¶å¹¿æ’­åˆ°æ‰€æœ‰æ£€æµ‹å™¨!');
                            fetchConfigs();
                        } else {
                            alert('Global config update failed');
                        }
                    } catch (e) { console.error(e); alert('Network error'); }
                };

                const batchContext = reactive({ product: '', line: '', station: '' }); // NEW

                const batchImport = async () => {
                    if (!importText.value.trim()) return;

                    // Split by newlines, taking first column if comma/tab separated
                    const items = importText.value.split(/\n/).map(line => {
                        line = line.trim();
                        if (!line) return null;
                        // Handle CSV row: "ItemName, ..."
                        if (line.includes(',')) return line.split(',')[0].trim();
                        if (line.includes('\t')) return line.split('\t')[0].trim();
                        return line;
                    }).filter(Boolean);

                    if (items.length === 0) {
                        alert('æ— æœ‰æ•ˆç›‘æ§é¡¹ (No valid items found)');
                        return;
                    }

                    // Enforce Mandatory Metadata
                    if (!batchContext.product || !batchContext.station || !batchContext.line) {
                        alert('é”™è¯¯ï¼šå¿…é¡»æŒ‡å®š äº§å“(Product)ã€å·¥ç«™(Station) å’Œ äº§çº¿(Line)ï¼\nè¿™äº›å‚æ•°å®šä¹‰äº†æ£€æµ‹æœåŠ¡çš„ç”Ÿæ•ˆèŒƒå›´ã€‚');
                        return;
                    }

                    // Construct meta_data (Force Lowercase)
                    const meta_data = {
                        product: batchContext.product.trim().toLowerCase(),
                        station: batchContext.station.trim().toLowerCase(),
                        line: batchContext.line.trim().toLowerCase()
                    };

                    try {
                        const res = await fetch('/api/v1/items/batch-import', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                items: items,
                                config: showBatchSettings.value ? batchConfig : null,
                                meta_data: meta_data
                            })
                        });
                        console.log("Batch Import Payload:", { items, meta_data, config: batchConfig }); // DEBUG log
                        const data = await res.json();
                        if (res.ok) {
                            alert(data.message);
                            showImportModal.value = false;
                            importText.value = '';
                            batchContext.product = ''; // Reset
                            batchContext.line = '';
                            batchContext.station = '';
                            fetchConfigs();
                            fetchOptions(); // update dropdowns too
                        } else {
                            alert('Import failed');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Network Error');
                    }
                };

                const openConfigEdit = (name, conf) => {
                    editingItemName.value = name;
                    // Merge global defaults if value is missing
                    Object.assign(editingConfig, {
                        target_shift_sigma: conf.target_shift_sigma ?? globalDefaults.value.target_shift_sigma,
                        target_arl0: conf.target_arl0 ?? globalDefaults.value.target_arl0,
                        cooldown_periods: conf.cooldown_periods ?? globalDefaults.value.cooldown_periods,
                        mu0: conf.mu0, // mu0 optional defined at item level
                        monitoring_side: conf.monitoring_side || 'upper', // default
                        base_uph: conf.base_uph ?? 500, // new
                        penalty_strength: conf.penalty_strength ?? 1.0 // new
                    });
                    showConfigModal.value = true;
                };

                const saveConfig = async () => {
                    try {
                        const res = await fetch(`/api/v1/configs/${editingItemName.value}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(editingConfig)
                        });
                        if (res.ok) {
                            showConfigModal.value = false;
                            fetchConfigs(); // Refresh list
                            alert('é…ç½®æ›´æ–°æˆåŠŸ! (å®æ—¶ç”Ÿæ•ˆ)');
                        } else {
                            alert('Update failed');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Network error');
                    }
                };

                const deleteItem = async (itemName) => {
                    if (!confirm(`Are you sure you want to delete item "${itemName}"? This cannot be undone.`)) {
                        return;
                    }
                    try {
                        const res = await fetch(`/api/v1/configs/${itemName}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            alert(`Item ${itemName} deleted successfully`);
                            fetchConfigs();
                        } else {
                            alert('Delete failed');
                        }
                    } catch (e) { console.error(e); alert('Network error'); }
                };


                // --- Dashboard Methods ---

                // (Logic moved to searchHistory)

                const openDetail = async (record) => {
                    selectedRecord.value = record;
                    showModal.value = true;

                    // è®¡ç®—å‰å 48 å°æ—¶ (ç¡®ä¿è¶³å¤Ÿè¦†ç›– 30+ å‘¨æœŸ)
                    const centerTime = new Date(record.timestamp);
                    const startTime = new Date(centerTime.getTime() - 48 * 60 * 60 * 1000).toISOString();
                    const endTime = new Date(centerTime.getTime() + 48 * 60 * 60 * 1000).toISOString();

                    const params = new URLSearchParams();
                    params.append('item_name', record.item_name);
                    params.append('start_time', startTime);
                    params.append('end_time', endTime);

                    // Fetch context data
                    const res = await fetch(`/api/v1/history?${params.toString()}`);
                    const data = await res.json();

                    await nextTick(); // Wait for DOM
                    renderDetailChart(data);
                };

                const renderDetailChart = (data) => {
                    if (detailChart) detailChart.dispose();
                    detailChart = echarts.init(document.getElementById('detailChart'));

                    const timestamps = data.map(r => formatTime(r.timestamp));
                    detailChart.setOption({
                        title: { text: '30å‘¨æœŸå…¨æ¯å¿«ç…§', left: 'center' },
                        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                        legend: { data: ['Value', 'CUSUM', 'Threshold'], top: 30 },
                        grid: { bottom: 50, right: 50, left: 50 },
                        xAxis: { type: 'category', data: timestamps },
                        yAxis: [{ type: 'value', name: 'Val' }, { type: 'value', name: 'Score' }],
                        dataZoom: [{ type: 'inside' }],
                        series: [
                            { name: 'Value', type: 'line', data: data.map(r => r.value), yAxisIndex: 0, color: '#3b82f6' },
                            { name: 'CUSUM', type: 'line', data: data.map(r => r.s_plus), yAxisIndex: 1, color: '#f59e0b', width: 3 },
                            { name: 'Threshold', type: 'line', data: data.map(r => r.h_value), yAxisIndex: 1, lineStyle: { type: 'dashed', color: '#ef4444' } }
                        ],
                        // MarkLine: æ ‡å‡ºæŠ¥è­¦æ—¶åˆ»
                        graphic: [{ type: 'line', shape: { x1: '50%', y1: 10, x2: '50%', y2: '90%' }, style: { stroke: 'rgba(255,0,0,0.3)', lineWidth: 1 } }]
                    });
                };


                const fetchOptions = async () => {
                    try {
                        // Build query
                        let query = '?';
                        if (filters.item_name) query += `item_name=${encodeURIComponent(filters.item_name)}&`;
                        if (filters.station) query += `station=${encodeURIComponent(filters.station)}&`;
                        if (filters.product) query += `product=${encodeURIComponent(filters.product)}&`;
                        if (filters.line) query += `line=${encodeURIComponent(filters.line)}&`;

                        // Add cache buster
                        query += `_t=${new Date().getTime()}`;

                        console.log('Fetching Options with query:', query);

                        const response = await fetch(`/api/v1/options${query}`);
                        const data = await response.json();

                        // console.log('Options received:', data);
                        options.value = data;
                    } catch (error) {
                        console.error('Failed to fetch options:', error);
                    }
                };

                // Expose to template
                const searchHistoryTrigger = searchHistory;

                onMounted(() => {
                    fetchConfigs();
                    fetchOptions(); // åŠ è½½ä¸‹æ‹‰èœå•
                    // Removed automatic fetchData() to enforce manual search
                    window.addEventListener('resize', () => {
                        mainChart && mainChart.resize();
                        baselineChart && baselineChart.resize();
                        detailChart && detailChart.resize();
                    });
                });

                const openImportModal = () => {
                    // Populate batchConfig with current defaults
                    Object.assign(batchConfig, {
                        target_shift_sigma: globalDefaults.value.target_shift_sigma,
                        target_arl0: globalDefaults.value.target_arl0,
                        cooldown_periods: globalDefaults.value.cooldown_periods,
                        monitoring_side: globalDefaults.value.monitoring_side || 'upper'
                    });
                    showImportModal.value = true;
                };

                // File Upload Logic
                const fileInput = ref(null);
                const triggerFileUpload = () => {
                    fileInput.value.click();
                };
                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();

                    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');

                    if (isExcel) {
                        reader.onload = (e) => {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });

                            // è¯»å–ç¬¬ä¸€ä¸ª Sheet
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];

                            // è½¬æ¢ä¸º JSON (header: 1 è¿”å›äºŒç»´æ•°ç»„)
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                            // æå–æœ‰æ•ˆçš„ç¬¬ä¸€åˆ—æ•°æ® (æ’é™¤ç©ºè¡Œ)
                            const items = jsonData.map(row => row[0]).filter(item => item && String(item).trim() !== "");

                            importText.value = items.join('\n');
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        // Text / CSV
                        reader.onload = (e) => {
                            const content = e.target.result;
                            importText.value = content;
                        };
                        reader.readAsText(file);
                    }

                    // Reset input so same file can be selected again
                    event.target.value = '';
                };

                return {
                    currentTab,
                    filters, options, fetchData, alertRecords, formatTime,
                    fetchOptions, searchHistory, // Exposed for template
                    showModal, selectedRecord, openDetail,
                    // Config Exports
                    configList, globalDefaults, showConfigModal, editingItemName, editingConfig,
                    fetchConfigs, openConfigEdit, saveConfig, deleteItem,
                    // Import Exports
                    showImportModal, importText, batchImport, saveGlobalConfig,
                    openImportModal, showBatchSettings, batchConfig, batchContext, // Export batchContext
                    fileInput, triggerFileUpload, handleFileUpload,
                    configSearch, filteredConfigs, configFilters, // Export configFilters
                    // Helper
                    calculateH,
                    // Selection
                    selectedItems, isAllSelected, toggleSelectAll, batchDelete
                };
            }
        }).mount('#app');
    </script>
</body>

</html>